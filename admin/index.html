<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Personality Test - Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #3b82f6;
      /* Indigo Blue */
      --primary-light: #60a5fa;
      --primary-dark: #3730a3;
      --secondary: #64748b;
      --accent: #14b8a6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --background: #fefefe;
      --surface: #ffffff;
      --surface-soft: #f8fafc;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-soft: #64748b;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --glass: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #6d28d9 0%, #3b82f6 100%);
      min-height: 100vh;
      color: var(--text);
      line-height: 1.6;
      padding: 0;
    }

    main {
      flex: 1;
    }

    .container-narrow {
      max-width: 900px;
    }

    .small-icon-container {
      width: 56px;
      height: 56px;
    }

    .glass-card {
      background: var(--glass);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
    }

    .modern-card {
      background: var(--surface);
      border: none;
      border-radius: 16px;
      box-shadow: var(--shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modern-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.15);
    }

    .header-glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .form-control-modern {
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 16px;
      transition: all 0.2s ease;
      background: var(--surface);
    }

    .form-control-modern:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      outline: none;
    }

    .btn-modern {
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 500;
      border: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn-primary.btn-modern {
      background: linear-gradient(135deg, var(--accent), var(--primary));
      box-shadow: 0 4px 14px rgba(20, 184, 166, 0.3);
    }

    .btn-primary.btn-modern:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px 0 rgba(79, 70, 229, 0.4);
    }

    .btn-outline-secondary.btn-modern {
      background: var(--surface);
      color: var(--secondary);
      border: 2px solid var(--border);
    }

    .btn-outline-secondary.btn-modern:hover {
      background: var(--surface-soft);
      border-color: var(--primary-light);
      color: var(--primary);
      transform: translateY(-1px);
    }

    .btn-success.btn-modern {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
      color: white;
    }

    .btn-success.btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px 0 rgba(16, 185, 129, 0.4);
    }

    .table-modern {
      background: var(--surface);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: none;
    }

    .table-modern th {
      background: var(--surface-soft);
      border: none;
      padding: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .table-modern td {
      padding: 16px;
      border: none;
      border-bottom: 1px solid var(--border);
    }

    .table-modern tr:last-child td {
      border-bottom: none;
    }

    .fade-enter {
      animation: slideUpFade 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .container-narrow {
        padding: 0 16px;
      }
      .btn-modern {
        padding: 14px 20px;
      }
      .table-modern th, .table-modern td {
        padding: 12px;
        font-size: 0.9rem;
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --background: #0f172a;
        --surface: #1e293b;
        --surface-soft: #334155;
        --border: #475569;
        --text: #f8fafc;
        --text-soft: #94a3b8;
        --glass: rgba(30, 41, 59, 0.8);
        --glass-border: rgba(148, 163, 184, 0.2);
      }
    }
  </style>
</head>

<body>
  <header class="py-4 header-glass">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
            <div class="small-icon-container d-flex align-items-center justify-content-center bg-white rounded-3 shadow">
            <i class="bi bi-shield-lock-fill fs-3 text-primary"></i>
            </div>
            <div class="text-white">
            <h1 class="h4 mb-0 fw-bold">Admin Dashboard</h1>
            <p class="mb-0 opacity-75">Personality Test Results</p>
            </div>
        </div>
        <div>
            <button id="btnExport" class="btn btn-success btn-modern d-flex align-items-center gap-2">
                <i class="bi bi-file-earmark-excel-fill"></i> <span class="d-none d-sm-inline">Export Excel</span>
            </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container py-5">
    
    <!-- FILTERS -->
    <div class="modern-card p-4 mb-4 fade-enter">
        <h5 class="fw-bold mb-3 text-primary"><i class="bi bi-funnel-fill me-2"></i>Filter Data</h5>
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label fw-semibold">Full Name</label>
          <input id="fullname" class="form-control form-control-modern" placeholder="Search fullname">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Company</label>
          <input id="company" class="form-control form-control-modern" placeholder="Search company">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Date</label>
          <input id="date" type="date" class="form-control form-control-modern">
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold">Limit</label>
          <select id="limit" class="form-select form-control-modern">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>

        <div class="col-md-1 d-grid">
           <button id="btnSearch" class="btn btn-primary btn-modern">
              <i class="bi bi-search"></i>
           </button>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="modern-card p-0 overflow-hidden fade-enter" style="animation-delay: 0.1s;">
      <div class="table-responsive">
        <table class="table table-modern mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fullname</th>
              <th>Gender</th>
              <th>Company</th>
              <th title="Koleris">K</th>
              <th title="Sanguinis">S</th>
              <th title="Melankolis">M</th>
              <th title="Phlegmatis">P</th>
              <th>Dominant</th>
              <th>Created At</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="text-center mt-4">
      <button id="btnLoadMore" class="btn btn-outline-secondary btn-modern d-none">
          <i class="bi bi-arrow-clockwise me-2"></i>Load More
      </button>
    </div>

  </main>
  
  <footer class="text-center py-4">
    <div class="container">
      <p class="text-white-50 mb-0">Â© 2024 Cipta Insan Aktif</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
  (function () {
    const API = "https://app-peserta.hadiahkugratis.com/personality-test/personalities";

    // -------------------------------------------------------------
    // DOM ELEMENTS
    // -------------------------------------------------------------
    const elements = {
      tbody: document.getElementById("tbody"),
      btnLoadMore: document.getElementById("btnLoadMore"),
      btnSearch: document.getElementById("btnSearch"),
      btnExport: document.getElementById("btnExport"),
      fullname: document.getElementById("fullname"),
      company: document.getElementById("company"),
      date: document.getElementById("date"),
      limit: document.getElementById("limit"),
    };

    // -------------------------------------------------------------
    // APP STATE
    // -------------------------------------------------------------
    const state = {
      lastID: 0,
    };

    // -------------------------------------------------------------
    // UTILITIES
    // -------------------------------------------------------------
    function escapeHTML(str = "") {
      if (typeof str !== "string") return str;
      return str.replace(/[&<>"'`]/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
        "`": "&#96;",
      }[m]));
    }

    function formatDate(d) {
      if (!d) return "-";
      const dt = new Date(d);
      const p = n => String(n).padStart(2, "0");
      return `${p(dt.getDate())}/${p(dt.getMonth() + 1)}/${dt.getFullYear()} ${p(dt.getHours())}:${p(dt.getMinutes())}:${p(dt.getSeconds())}`;
    }

    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: "application/vnd.ms-excel" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // -------------------------------------------------------------
    // FILTER + PARAM BUILDERS
    // -------------------------------------------------------------
    function getFilters() {
      return {
        limit: elements.limit.value,
        fullname: elements.fullname.value.trim(),
        company: elements.company.value.trim(),
        date: elements.date.value,
      };
    }

    function buildParams({ filters, lastID = 0 }) {
      const params = { limit: filters.limit };

      if (filters.fullname) params.fullname = filters.fullname;
      if (filters.company) params.company = filters.company;
      if (filters.date) params.date = filters.date;
      if (lastID > 0) params.lastID = lastID;

      return params;
    }

    // -------------------------------------------------------------
    // RENDERING
    // -------------------------------------------------------------
    function renderRow(row) {
      const html = `
        <tr>
          <td>${row.id}</td>
          <td>${escapeHTML(row.fullname || "-")}</td>
          <td>${escapeHTML(row.gender || "-")}</td>
          <td>${escapeHTML(row.company || "-")}</td>
          <td>${row.koleris_percentage}%</td>
          <td>${row.sanguinis_percentage}%</td>
          <td>${row.melankolis_percentage}%</td>
          <td>${row.phlegmatis_percentage}%</td>
          <td>${escapeHTML(row.dominant_personality || "-")}</td>
          <td>${formatDate(row.createdAt)}</td>
          <td>
            <a class="btn btn-sm btn-outline-primary"
              href="https://apps.ciptainsanaktif.com/personality?result_id=${row.id}"
              target="_blank">Open</a>
          </td>
        </tr>
      `;
      elements.tbody.insertAdjacentHTML("beforeend", html);
    }

    function renderRows(rows) {
      rows.forEach(renderRow);
    }

    // -------------------------------------------------------------
    // DATA FETCHING
    // -------------------------------------------------------------
    async function fetchPage(filters, lastID = 0) {
      const params = buildParams({ filters, lastID });
      const res = await axios.get(API, { params });
      return res.data.payload;
    }

    async function loadData(reset = false) {
      const filters = getFilters();

      if (reset) {
        elements.tbody.innerHTML = "";
        state.lastID = 0;
      }

      try {
        const payload = await fetchPage(filters, state.lastID);

        renderRows(payload.datas);
        state.lastID = payload.lastID;

        elements.btnLoadMore.classList.toggle("d-none", !payload.hasMore);
      } catch (err) {
        console.error("LOAD DATA ERROR:", err);
        alert("Failed to load data.");
      }
    }

    // -------------------------------------------------------------
    // EXPORT LOGIC
    // -------------------------------------------------------------
    async function fetchAllData(filters) {
      let lastID = 0;
      let rows = [];
      let hasMore = true;

      while (hasMore) {
        const payload = await fetchPage(filters, lastID);
        rows = rows.concat(payload.datas);
        lastID = payload.lastID;
        hasMore = payload.hasMore;
      }

      return rows;
    }

    function convertToExcel(rows) {
      const header = `
        <tr>
          <th>ID</th>
          <th>Fullname</th>
          <th>Gender</th>
          <th>Company</th>
          <th>Koleris</th>
          <th>Sanguinis</th>
          <th>Melankolis</th>
          <th>Phlegmatis</th>
          <th>Dominant</th>
          <th>Created At</th>
        </tr>
      `;

      const body = rows
        .map(r => `
          <tr>
            <td>${r.id}</td>
            <td>${escapeHTML(r.fullname || "")}</td>
            <td>${escapeHTML(r.gender || "")}</td>
            <td>${escapeHTML(r.company || "")}</td>
            <td>${r.koleris_percentage}%</td>
            <td>${r.sanguinis_percentage}%</td>
            <td>${r.melankolis_percentage}%</td>
            <td>${r.phlegmatis_percentage}%</td>
            <td>${escapeHTML(r.dominant_personality || "")}</td>
            <td>${formatDate(r.createdAt)}</td>
          <\/tr>
        `)
        .join("");

      return `
        <html xmlns:o="urn:schemas-microsoft-com:office:office"
              xmlns:x="urn:schemas-microsoft-com:office:excel"
              xmlns="http://www.w3.org/TR/REC-html40">
        <head><meta charset="utf-8" /><\/head>
        <body>
          <table border="1">${header}${body}<\/table>
        <\/body>
        <\/html>
      `;
    }

    async function exportExcel() {
      const filters = getFilters();

      try {
        elements.btnExport.disabled = true;
        elements.btnExport.textContent = "Loading...";

        const rows = await fetchAllData(filters);
        if (rows.length === 0) return alert("No data to export.");

        const xls = convertToExcel(rows);
        downloadFile(xls, "personality_result.xls");
      } catch (err) {
        console.error("EXPORT ERROR:", err);
        alert("Failed to export Excel.");
      } finally {
        elements.btnExport.disabled = false;
        elements.btnExport.textContent = "Download Excel";
      }
    }

    // -------------------------------------------------------------
    // EVENT BINDINGS
    // -------------------------------------------------------------
    function bindEvents() {
      elements.btnSearch.addEventListener("click", () => loadData(true));
      elements.btnLoadMore.addEventListener("click", () => loadData(false));
      elements.btnExport.addEventListener("click", exportExcel);
    }

    // -------------------------------------------------------------
    // INIT
    // -------------------------------------------------------------
    window.addEventListener("load", () => {
      bindEvents();
      loadData(true);
    });

  })();
  </script>

</body>

</html>